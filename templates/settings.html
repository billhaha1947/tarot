{% extends "layout.html" %}

{% block title %}C√†i ƒë·∫∑t - Tarot AI Oracle{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <a href="/chat" class="inline-flex items-center gap-2 text-neon-cyan hover:text-neon-purple transition-colors mb-4">
                ‚Üê Quay l·∫°i Chat
            </a>
            <h1 class="text-4xl font-bold orbitron neon-text-cyan">C√†i ƒë·∫∑t</h1>
            <p class="text-gray-400 mt-2">T√πy ch·ªânh tr·∫£i nghi·ªám Oracle c·ªßa b·∫°n</p>
        </div>
        
        <div class="grid gap-6">
            <!-- Profile Settings -->
            <div class="glass-strong rounded-2xl p-6 slide-in-up">
                <h2 class="text-2xl font-bold mb-6 neon-text-purple">üë§ H·ªì s∆° c√° nh√¢n</h2>
                
                <div class="space-y-6">
                    <!-- Avatar -->
                    <div class="flex items-center gap-6">
                        <img id="avatarPreview" src="/static/avatar/default.png" alt="Avatar" 
                             class="w-24 h-24 rounded-full border-4 border-neon-cyan neon-glow-cyan">
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">Avatar</label>
                            <input type="file" id="avatarInput" accept="image/*" 
                                   class="hidden">
                            <button id="uploadAvatarBtn" class="btn-primary px-6 py-2 rounded-lg">
                                üì§ T·∫£i l√™n
                            </button>
                            <p class="text-xs text-gray-400 mt-2">PNG, JPG, GIF (Max 5MB)</p>
                        </div>
                    </div>
                    
                    <!-- User Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                            <input type="text" id="displayUsername" disabled
                                   class="input-glass w-full px-4 py-2 rounded-lg opacity-50 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="displayEmail" disabled
                                   class="input-glass w-full px-4 py-2 rounded-lg opacity-50 cursor-not-allowed">
                        </div>
                    </div>
                    
                    <!-- Change Password -->
                    <div class="border-t border-gray-700 pt-6">
                        <h3 class="text-lg font-semibold mb-4">ƒê·ªïi m·∫≠t kh·∫©u</h3>
                        <form id="changePasswordForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">M·∫≠t kh·∫©u c≈©</label>
                                <input type="password" id="oldPassword" 
                                       class="input-glass w-full px-4 py-2 rounded-lg"
                                       placeholder="Nh·∫≠p m·∫≠t kh·∫©u c≈©">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">M·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" id="newPassword" 
                                       class="input-glass w-full px-4 py-2 rounded-lg"
                                       placeholder="√çt nh·∫•t 6 k√Ω t·ª±">
                            </div>
                            <button type="submit" class="btn-primary px-6 py-2 rounded-lg">
                                üîí ƒê·ªïi m·∫≠t kh·∫©u
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- AI Settings -->
            <div class="glass-strong rounded-2xl p-6 slide-in-up" style="animation-delay: 0.1s">
                <h2 class="text-2xl font-bold mb-6 neon-text-cyan">ü§ñ C√†i ƒë·∫∑t AI</h2>
                
                <div class="space-y-6">
                    <!-- Model Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2">M√¥ h√¨nh AI</label>
                        <select id="modelSelect" class="input-glass w-full px-4 py-2 rounded-lg">
                            <option value="pseudo_tarot">Pseudo Tarot AI (Built-in)</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-2">Ch·ªçn m√¥ h√¨nh AI ƒë·ªÉ s·ª≠ d·ª•ng</p>
                    </div>
                    
                    <!-- Temperature -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Temperature: <span id="tempValue" class="text-neon-cyan">0.8</span>
                        </label>
                        <input type="range" id="temperatureSlider" 
                               min="0" max="1" step="0.1" value="0.8"
                               class="w-full">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>Ch√≠nh x√°c (0.0)</span>
                            <span>S√°ng t·∫°o (1.0)</span>
                        </div>
                    </div>
                    
                    <!-- Max Tokens -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Max Tokens: <span id="tokensValue" class="text-neon-cyan">500</span>
                        </label>
                        <input type="range" id="maxTokensSlider" 
                               min="100" max="1000" step="50" value="500"
                               class="w-full">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>Ng·∫Øn (100)</span>
                            <span>D√†i (1000)</span>
                        </div>
                    </div>
                    
                    <button id="saveSettingsBtn" class="btn-primary px-6 py-2 rounded-lg">
                        üíæ L∆∞u c√†i ƒë·∫∑t
                    </button>
                </div>
            </div>
            
            <!-- About -->
            <div class="glass-strong rounded-2xl p-6 slide-in-up" style="animation-delay: 0.2s">
                <h2 class="text-2xl font-bold mb-4 neon-text-purple">‚ÑπÔ∏è Th√¥ng tin</h2>
                <div class="space-y-2 text-gray-400">
                    <p>üé¥ <strong class="text-white">78 L√° Tarot</strong> - Major & Minor Arcana ƒë·∫ßy ƒë·ªß</p>
                    <p>ü§ñ <strong class="text-white">AI Oracle</strong> - D·ª± ƒëo√°n th√¥ng minh v·ªõi streaming</p>
                    <p>üí¨ <strong class="text-white">Real-time Chat</strong> - WebSocket streaming</p>
                    <p>üîí <strong class="text-white">100% Offline</strong> - Ho·∫°t ƒë·ªông ho√†n to√†n local</p>
                    <p class="text-sm mt-4">Version 1.0.0 | Built with Flask, Socket.IO & TailwindCSS</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Check auth
    if (!getToken()) {
        window.location.href = '/';
    }
    
    let currentSettings = {
        model: 'pseudo_tarot',
        temperature: 0.8,
        max_tokens: 500
    };
    
    // Load user data
    async function loadUserData() {
        try {
            const user = await apiRequest('/api/user');
            document.getElementById('displayUsername').value = user.username;
            document.getElementById('displayEmail').value = user.email;
            document.getElementById('avatarPreview').src = user.avatar;
        } catch (error) {
            showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng', 'error');
        }
    }
    
    // Load AI settings
    async function loadSettings() {
        try {
            const [models, settings] = await Promise.all([
                apiRequest('/api/models'),
                apiRequest('/api/settings')
            ]);
            
            // Populate models
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = models.map(m => 
                `<option value="${m.id}">${m.name}</option>`
            ).join('');
            
            // Set current values
            modelSelect.value = settings.model;
            document.getElementById('temperatureSlider').value = settings.temperature;
            document.getElementById('maxTokensSlider').value = settings.max_tokens;
            document.getElementById('tempValue').textContent = settings.temperature;
            document.getElementById('tokensValue').textContent = settings.max_tokens;
            
            currentSettings = settings;
        } catch (error) {
            showToast('Kh√¥ng th·ªÉ t·∫£i c√†i ƒë·∫∑t', 'error');
        }
    }
    
    // Upload avatar
    document.getElementById('uploadAvatarBtn').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
    });
    
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('File qu√° l·ªõn (max 5MB)', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('avatar', file);
        
        try {
            const response = await fetch('/api/user/avatar', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getToken()}`
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error);
            }
            
            document.getElementById('avatarPreview').src = data.avatar;
            showToast('T·∫£i avatar th√†nh c√¥ng!', 'success');
            
            // Update user in storage
            const user = getUser();
            user.avatar = data.avatar;
            setUser(user);
            
        } catch (error) {
            showToast(error.message || 'T·∫£i avatar th·∫•t b·∫°i', 'error');
        }
    });
    
    // Change password
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        
        if (!oldPassword || !newPassword) {
            showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'warning');
            return;
        }
        
        if (newPassword.length < 6) {
            showToast('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'warning');
            return;
        }
        
        try {
            await apiRequest('/api/user/password', {
                method: 'PUT',
                body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
            });
            
            showToast('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
            document.getElementById('changePasswordForm').reset();
            
        } catch (error) {
            showToast(error.message || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i', 'error');
        }
    });
    
    // Update sliders
    document.getElementById('temperatureSlider').addEventListener('input', (e) => {
        document.getElementById('tempValue').textContent = e.target.value;
    });
    
    document.getElementById('maxTokensSlider').addEventListener('input', (e) => {
        document.getElementById('tokensValue').textContent = e.target.value;
    });
    
    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
        const settings = {
            model: document.getElementById('modelSelect').value,
            temperature: parseFloat(document.getElementById('temperatureSlider').value),
            max_tokens: parseInt(document.getElementById('maxTokensSlider').value)
        };
        
        try {
            await apiRequest('/api/settings', {
                method: 'PUT',
                body: JSON.stringify(settings)
            });
            
            showToast('L∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
            currentSettings = settings;
            
        } catch (error) {
            showToast(error.message || 'L∆∞u c√†i ƒë·∫∑t th·∫•t b·∫°i', 'error');
        }
    });
    
    // Initialize
    loadUserData();
    loadSettings();
</script>
{% endblock %}
